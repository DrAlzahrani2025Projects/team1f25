#!/usr/bin/env bash
set -euo pipefail

# --- Apache Configuration ---
PROXY_DOMAIN="sec.cse.csusb.edu"
PROXY_PATH="/team1f25"
DOCKER_APP_PORT="5001"

SSL_SEARCH_STRING="SSLCertificateFile /etc/letsencrypt/live/${PROXY_DOMAIN}/"
SITES_AVAILABLE_DIR="/etc/apache2/sites-available"

# Must be root for a2enmod / editing vhost / reload
if [ "$EUID" -ne 0 ]; then
  echo "Error: Apache configuration requires root. Please run with sudo."
  exit 1
fi

echo "--- Locating HTTPS VirtualHost for ${PROXY_DOMAIN} ---"
CONFIG_FILE="$(grep -l -R "$SSL_SEARCH_STRING" "$SITES_AVAILABLE_DIR" 2>/dev/null | head -n 1)"
if [ -z "${CONFIG_FILE}" ]; then
  echo "Error: Could not find an Apache HTTPS VirtualHost file for ${PROXY_DOMAIN}."
  echo "Ensure certs exist and the vhost is under ${SITES_AVAILABLE_DIR}."
  exit 1
fi
echo "Found: ${CONFIG_FILE}"

echo "--- Enabling required Apache modules ---"
a2enmod proxy proxy_http proxy_wstunnel rewrite headers ssl >/dev/null

# Desired replacement block
read -r -d '' NEW_BLOCK <<'EOF'
# --- Streamlit reverse proxy for team1f25 ---
ProxyRequests Off

<Proxy "*">
    Require all granted
</Proxy>

RewriteEngine On
# Normalize missing trailing slash: /team1f25 -> /team1f25/
RewriteRule ^/team1f25$ /team1f25/ [R=301,L]

# Core HTTP proxy (TRAILING SLASHES ARE IMPORTANT)
ProxyPass        /team1f25/ http://localhost:5001/team1f25/ retry=0 keepalive=On
ProxyPassReverse /team1f25/ http://localhost:5001/team1f25/

# WebSocket upgrade for Streamlit
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteRule ^/team1f25/(.*) ws://localhost:5001/team1f25/$1 [P,L]

# Preserve scheme info for the app
RequestHeader set X-Forwarded-Proto "https"
# --- End Streamlit reverse proxy for team1f25 ---
EOF

# Note: The NEW_BLOCK above uses the literal values you provided:
#   - PROXY_PATH: /team1f25
#   - DOCKER_APP_PORT: 5001
# If you want this script to be fully parametric, you can sed-in the variables.

echo "--- Backing up vhost file ---"
cp -a "${CONFIG_FILE}" "${CONFIG_FILE}.bak.$(date +%Y%m%d-%H%M%S)"

LEGACY_HEADER_LINE='########################################'
LEGACY_TITLE_LINE='# Streamlit reverse proxy for team1f25'
NEW_MARKER='# --- Streamlit reverse proxy for team1f25 ---'

if grep -qF "${NEW_MARKER}" "${CONFIG_FILE}"; then
  echo "New-style block already present. Updating it in-place…"
  # Replace everything between our start/end markers with NEW_BLOCK
  awk -v RS= -v ORS="" -v new_block="$NEW_BLOCK" '
    {
      gsub(/\r/,"") # normalize
      if ($0 ~ /# --- Streamlit reverse proxy for team1f25 ---/) {
        # replace the whole marked block
        sub(/# --- Streamlit reverse proxy for team1f25 ---([^-]|-([^E]|E([^n]|en([^d]|end([^ ]| end([^S]| end S([^t]| end St([^r]| end Str([^e]| end Stre([^a]| end Strea([^m]| end Stream([^l]| end Streaml([^i]| end Streamli([^t]| end Streamlit([^ ]| end Streamlit ([^r]| end Streamlit re([^v]| end Streamlit rev([^e]| end Streamlit reve([^r]| end Streamlit rever([^s]| end Streamlit revers([^e]| end Streamlit reverse([^ ]| end Streamlit reverse ([^p]| end Streamlit reverse pr([^o]| end Streamlit reverse pro([^x]| end Streamlit reverse prox([^y]| end Streamlit reverse proxy([^ ]| end Streamlit reverse proxy ([^f]| end Streamlit reverse proxy fo([^r]| end Streamlit reverse proxy for([^ ]| end Streamlit reverse proxy for )[^-]|-[^-]|--[^ ]|---[^ ]|----[^ ]|-----[^ ]|------[^ ]|-------[^ ]|--------[^ ]|---------[^ ]|----------[^ ]|-----------[^ ]|------------[^ ]|-------------[^ ]|--------------[^ ]|---------------[^ ]|----------------[^ ]|-----------------[^ ]|------------------[^ ]|-------------------[^ ]|--------------------[^ ]|---------------------[^ ]|----------------------[^ ]|-----------------------[^ ]|------------------------[^ ]|-------------------------[^ ]|--------------------------[^ ]|---------------------------[^ ]|----------------------------[^ ]|-----------------------------[^ ]|------------------------------[^ ]|-------------------------------[^ ]|--------------------------------[^ ]|---------------------------------[^ ]|----------------------------------[^ ]|-----------------------------------[^ ]|------------------------------------[^ ]|-------------------------------------[^ ]|--------------------------------------[^ ]|---------------------------------------[^ ]|----------------------------------------[^ ]|-----------------------------------------[^ ]|------------------------------------------[^ ]|-------------------------------------------[^ ]|--------------------------------------------[^ ]|---------------------------------------------[^ ]|----------------------------------------------[^ ]|-----------------------------------------------[^ ]|------------------------------------------------[^ ]|-------------------------------------------------[^ ]|--------------------------------------------------[^ ]|---------------------------------------------------[^ ]|----------------------------------------------------[^ ]|-----------------------------------------------------[^ ]|------------------------------------------------------[^ ]|-------------------------------------------------------[^ ]|--------------------------------------------------------[^ ]|---------------------------------------------------------[^ ]|----------------------------------------------------------[^ ]|-----------------------------------------------------------[^ ]|------------------------------------------------------------[^ ]|-------------------------------------------------------------[^ ]|--------------------------------------------------------------[^ ]|---------------------------------------------------------------[^ ]|----------------------------------------------------------------[^ ]|-----------------------------------------------------------------[^ ]|------------------------------------------------------------------[^ ]|-------------------------------------------------------------------[^ ]|--------------------------------------------------------------------[^ ]|---------------------------------------------------------------------[^ ]|----------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------[^ ]|------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------[^ ]|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n?# --- End Streamlit reverse proxy for team1f25 ---/, new_block)
      }
      print $0
    }
  ' "${CONFIG_FILE}" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "${CONFIG_FILE}"
else
  if grep -qF "${LEGACY_TITLE_LINE}" "${CONFIG_FILE}"; then
    echo "Found legacy block. Replacing it with the new block…"
    # Replace the legacy block that starts with the '####' banner + title line
    awk -v new_block="$NEW_BLOCK" -v hdr="$LEGACY_HEADER_LINE" -v title="$LEGACY_TITLE_LINE" '
      BEGIN{in_legacy=0; have_prev=0; prev=""}
      {
        line=$0
        if (!in_legacy) {
          if (have_prev && prev==hdr && line==title) {
            # At start of legacy block: print NEW_BLOCK once, and start skipping
            print prev "# REPLACED legacy Streamlit proxy block below\n" new_block
            in_legacy=1
            have_prev=0
            next
          } else {
            if (have_prev) print prev
            prev=line
            have_prev=1
            next
          }
        } else {
          # We are skipping the legacy block until we hit the next banner
          if (line==hdr) {
            # end of legacy block; keep this hdr for normal flow
            prev=line
            have_prev=1
            in_legacy=0
            next
          } else {
            # keep skipping
            next
          }
        }
      }
      END{
        if (!in_legacy && have_prev) print prev
      }
    ' "${CONFIG_FILE}" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "${CONFIG_FILE}"
  else
    echo "No legacy or new block found. Appending new block to the end of the vhost file."
    printf "\n%s\n%s\n" "${LEGACY_HEADER_LINE}" "${NEW_BLOCK}" >> "${CONFIG_FILE}"
  fi
fi

echo "--- Testing Apache configuration ---"
if ! apachectl configtest &>/dev/null; then
  echo "Error: Apache configuration test failed. Restoring backup."
  cp -a "${CONFIG_FILE}.bak."* "${CONFIG_FILE}" 2>/dev/null || true
  exit 1
fi

echo "--- Reloading Apache ---"
systemctl reload apache2

echo "✅ Done. Streamlit proxy block is now normalized."
echo "   Test locally on the server: curl -I http://localhost:5001/team1f25/"
echo "   Public URL: https://${PROXY_DOMAIN}/team1f25/"
