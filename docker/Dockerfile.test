FROM python:3.12-slim

WORKDIR /app

# Allow passing API keys at build time (optional). Prefer passing at runtime for secrets.
ARG GROQ_API_KEY
ARG PRIMO_API_KEY

# Copy requirements and install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir pytest pytest-mock pytest-cov

# Copy application code
COPY app.py .
COPY core/ core/
COPY ui/ ui/

# Copy test infrastructure
COPY tests/ tests/
COPY pytest.ini .
COPY scripts/ scripts/

# Set environment variables for testing
ENV PYTHONPATH=/app
ENV GROQ_API_KEY=${GROQ_API_KEY}

# Default command to run new pytest-based tests
# Can be overridden at runtime:
#   docker run <image> python scripts/run_pytest.py unit
#   docker run <image> python scripts/run_pytest.py integration
#   docker run <image> python scripts/run_pytest.py all
#   docker run <image> python scripts/run_pytest.py legacy
CMD ["python", "scripts/run_pytest.py", "unit"]