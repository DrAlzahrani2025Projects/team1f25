# Common server docroot (not used by the app, but safe defaults)
DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
  Require all granted
</Directory>

ProxyRequests Off
ProxyPreserveHost On
RewriteEngine On

# ---------------------------
# JUPYTER (FIRST, most specific)
# Backend expects the prefix /team1f25/jupyter/
# ---------------------------
# WebSocket upgrades
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteRule ^/team1f25/jupyter/(.*)$  ws://team1f25-jupyter:8888/team1f25/jupyter/$1 [P,L]

# HTTP proxy (keep the exact prefix)
ProxyPass        /team1f25/jupyter/  http://team1f25-jupyter:8888/team1f25/jupyter/
ProxyPassReverse /team1f25/jupyter/  http://team1f25-jupyter:8888/team1f25/jupyter/
ProxyPass        /team1f25/jupyter   http://team1f25-jupyter:8888/team1f25/jupyter
ProxyPassReverse /team1f25/jupyter   http://team1f25-jupyter:8888/team1f25/jupyter

# ---------------------------
# STREAMLIT APP (LAST, catch-all under /team1f25/)
# Streamlit is started with --server.baseUrlPath=team1f25
# ---------------------------
# WebSocket upgrades for the app (exclude jupyter paths)
RewriteCond %{REQUEST_URI} !^/team1f25/jupyter [NC]
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
# preserve /team1f25 prefix on backend too
RewriteRule ^/team1f25/(.*)$  ws://team1f25-app:5001/team1f25/$1 [P,L]

# Redirect /team1f25 â†’ /team1f25/ (trailing slash)
RewriteCond %{REQUEST_URI} ^/team1f25$
RewriteRule ^/team1f25$ /team1f25/ [R=301,L]

# HTTP proxy to Streamlit (preserve prefix)
ProxyPass        /team1f25/  http://team1f25-app:5001/team1f25/
ProxyPassReverse /team1f25/  http://team1f25-app:5001/team1f25/
ProxyPass        /team1f25   http://team1f25-app:5001/team1f25
ProxyPassReverse /team1f25   http://team1f25-app:5001/team1f25
