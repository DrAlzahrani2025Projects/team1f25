<VirtualHost *:80>
  ProxyPreserveHost On
  RewriteEngine On

  # --- WebSocket upgrades ---
  # Jupyter WS
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/team1f25/jupyter/(.*)$ ws://team1f25-jupyter:8888/team1f25/jupyter/$1 [P,L]

  # App WS (exclude jupyter)
  RewriteCond %{REQUEST_URI} !^/team1f25/jupyter [NC]
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/team1f25/(.*)$ ws://team1f25-app:5001/$1 [P,L]

  # --- Jupyter FIRST ---
  # match both /team1f25/jupyter and /team1f25/jupyter/ + subpaths
  ProxyPass        /team1f25/jupyter/  http://team1f25-jupyter:8888/team1f25/jupyter/
  ProxyPassReverse /team1f25/jupyter/  http://team1f25-jupyter:8888/team1f25/jupyter/
  ProxyPass        /team1f25/jupyter   http://team1f25-jupyter:8888/team1f25/jupyter
  ProxyPassReverse /team1f25/jupyter   http://team1f25-jupyter:8888/team1f25/jupyter

  # Redirect /team1f25 to /team1f25/ (with trailing slash)
  RewriteEngine On
  RewriteCond %{REQUEST_URI} ^/team1f25$
  RewriteRule ^/team1f25$ /team1f25/ [R=301,L]

  # --- App LAST ---
  ProxyPass        /team1f25/  http://team1f25-app:5001/
  ProxyPassReverse /team1f25/  http://team1f25-app:5001/
  ProxyPass        /team1f25   http://team1f25-app:5001/
  ProxyPassReverse /team1f25   http://team1f25-app:5001/
</VirtualHost>
