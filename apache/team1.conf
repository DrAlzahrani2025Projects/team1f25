<VirtualHost *:80>
  ProxyPreserveHost On
  RewriteEngine On

  # --- WebSocket upgrades ---
  # Jupyter WS
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/team1/jupyter/(.*)$ ws://team1-jupyter:8888/team1/jupyter/$1 [P,L]

  # App WS (exclude jupyter)
  RewriteCond %{REQUEST_URI} !^/team1/jupyter [NC]
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/team1/(.*)$ ws://team1-app:5001/$1 [P,L]

  # --- Jupyter FIRST ---
  # match both /team1/jupyter and /team1/jupyter/ + subpaths
  ProxyPass        /team1/jupyter/  http://team1-jupyter:8888/team1/jupyter/
  ProxyPassReverse /team1/jupyter/  http://team1-jupyter:8888/team1/jupyter/
  ProxyPass        /team1/jupyter   http://team1-jupyter:8888/team1/jupyter
  ProxyPassReverse /team1/jupyter   http://team1-jupyter:8888/team1/jupyter

  # --- App LAST ---
  ProxyPass        /team1/  http://team1-app:5001/
  ProxyPassReverse /team1/  http://team1-app:5001/
</VirtualHost>
