name: Docker Scout Report

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

concurrency:
  group: docker-scout-${{ github.ref }}
  cancel-in-progress: true

jobs:
  report:
    name: Build image, scan, and write Markdown report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write  # needed to commit docs/ on trusted events

    env:
      BRANCH_NAME: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}

    steps:
      - name: Checkout (on real branch)
        uses: actions/checkout@v4
        with:
          # checkout the source branch (PR head branch or current branch on push)
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Choose local tag
        id: tag
        run: echo "val=local/team1f25-streamlit:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build image (local only; no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64
          load: true
          push: false
          tags: ${{ steps.tag.outputs.val }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Authenticate to Docker Hub only on trusted events (not forked PRs)
      - name: Log in to Docker Hub
        if: >
          github.event_name != 'pull_request' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Run Scout only when authenticated (trusted contexts)
      - name: Scan with Docker Scout (JSON output)
        id: scout
        if: >
          github.event_name != 'pull_request' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.tag.outputs.val }}
          only-severities: critical,high
          exit-code: false
          output: report.json
          format: json
          summary: false
          write-comment: false

      - name: Generate Markdown report
        if: always()
        run: |
          mkdir -p docs
          {
            echo "# ðŸ§­ Docker Scout Security Vulnerability Report"
            echo
            echo "**Date:** $(date -u)"
            echo "**Git SHA:** ${{ github.sha }}"
            echo "**Branch/Ref:** ${{ env.BRANCH_NAME }}"
            echo
            echo "## ðŸ³ Image Scanned"
            echo "\`${{ steps.tag.outputs.val }}\`"
            echo
            if [ -f report.json ]; then
              echo "## ðŸš¨ Summary of High/Critical Vulnerabilities"
              echo
              echo "| Severity | Package | CVE | Description | Fixed In |"
              echo "|-----------|---------|-----|-------------|----------|"
              jq -r '
                (.vulnerabilities // [])
                | map(select((.severity // "" | ascii_downcase)=="critical" or (.severity // "" | ascii_downcase)=="high"))
                | if length==0 then
                    empty
                  else
                    .[]
                    | "| \(.severity) | \((.package // .package_name // "unknown")) | \(.cve // "N/A") | \((.description // "" | gsub("\n"; " "))) | \((.fixVersion // .fixed_version // "N/A")) |"
                  end
              ' report.json
              if [ $? -ne 0 ] || [ "$(jq -r '(.vulnerabilities // []) | map(select((.severity // "" | ascii_downcase)=="critical" or (.severity // "" | ascii_downcase)=="high")) | length' report.json)" = "0" ]; then
                echo "| â€” | â€” | â€” | No High/Critical vulnerabilities found. | â€” |"
              fi
            else
              echo "## â„¹ï¸ Scan Skipped"
              echo
              echo "_This run didnâ€™t authenticate to Docker Hub (likely a PR from a fork), so Docker Scout was skipped to protect secrets. Results will appear on trusted runs (pushes, internal PRs)._"
            fi
            echo
            echo "---"
            echo "_Generated automatically by Docker Scout GitHub Action_"
          } > docs/Docker_Scout_Report.md

      - name: Upload Markdown and JSON as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-markdown-and-json
          path: |
            docs/Docker_Scout_Report.md
            report.json
          retention-days: 7

      # Commit report back to repo only on trusted contexts (not forked PRs)
      - name: Commit Docker Scout Report
        if: >
          ( github.event_name != 'pull_request' ) ||
          ( github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false )
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin "${BRANCH_NAME}" || true
          git add docs/Docker_Scout_Report.md
          git commit -m "Add Docker Scout Report for ${{ github.sha }}" || echo "No changes to commit"
          git push origin HEAD:"${BRANCH_NAME}"
