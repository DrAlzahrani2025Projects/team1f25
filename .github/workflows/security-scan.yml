name: Docker Scout Report

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

concurrency:
  group: docker-scout-${{ github.ref }}
  cancel-in-progress: true

jobs:
  report:
    # Safeguard against infinite loops:
    # - Don't run if the committer is the Actions bot
    # - Don't run if the commit message is our auto-report commit
    if: github.actor != 'github-actions[bot]' && !contains((github.event.head_commit.message || ''), 'Add Docker Scout Report')
    name: Build image, scan, and write Markdown report
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write  # needed to commit docs/ on trusted events

    env:
      # Source branch for commits (PR head ref on PRs, current branch on pushes)
      BRANCH_NAME: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}
      # Explicit paths for scan outputs
      SCAN_DIR: .scan
      SCAN_JSON: .scan/report.json

    steps:
      - name: Checkout (on real branch)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Choose local tag
        id: tag
        run: echo "val=local/team1f25-streamlit:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build image (local only; no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64
          load: true
          push: false
          tags: ${{ steps.tag.outputs.val }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Authenticate to Docker Hub only on trusted events (not forked PRs)
      - name: Log in to Docker Hub
        if: >
          github.event_name != 'pull_request' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare scan dir
        run: mkdir -p "$SCAN_DIR"

      # Run Scout action (may not always write the file reliably)
      - name: Scan with Docker Scout (JSON output)
        id: scout
        if: >
          github.event_name != 'pull_request' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ steps.tag.outputs.val }}
          only-severities: critical,high
          exit-code: false
          output: ${{ env.SCAN_JSON }}  # desired path
          format: json
          summary: false
          write-comment: false

      # Fallback: if the action didn't create the file, use the CLI directly
      - name: Fallback: write JSON via Docker Scout CLI if missing
        if: always()
        run: |
          if [ ! -f "$SCAN_JSON" ]; then
            echo "Scout JSON missing; generating via CLI fallback..."
            docker scout cves "${{ steps.tag.outputs.val }}" --format json > "$SCAN_JSON" || true
          fi

      # Last resort: ensure a tiny placeholder so the Markdown step never 'skips'
      - name: Ensure placeholder report.json if still absent
        if: always()
        run: |
          if [ ! -f "$SCAN_JSON" ]; then
            echo '{"vulnerabilities":[],"_note":"scan was skipped or failed to authenticate"}' > "$SCAN_JSON"
          fi

      - name: Debug report.json presence
        if: always()
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "SCAN_DIR listing:"
          ls -la "$SCAN_DIR" || true
          if [ -f "$SCAN_JSON" ]; then
            echo "Found $SCAN_JSON (first 200 bytes):"
            head -c 200 "$SCAN_JSON" || true
            echo
          else
            echo "MISSING $SCAN_JSON"
          fi

      - name: Generate Markdown report
        if: always()
        run: |
          mkdir -p docs
          {
            echo "# ðŸ§­ Docker Scout Security Vulnerability Report"
            echo
            echo "**Date:** $(date -u)"
            echo "**Git SHA:** ${{ github.sha }}"
            echo "**Branch/Ref:** ${{ env.BRANCH_NAME }}"
            echo
            echo "## ðŸ³ Image Scanned"
            echo "\`${{ steps.tag.outputs.val }}\`"
            echo
            echo "## ðŸš¨ Summary of High/Critical Vulnerabilities"
            echo
            echo "| Severity | Package | CVE | Description | Fixed In |"
            echo "|-----------|---------|-----|-------------|----------|"
            jq -r '
              (.vulnerabilities // [])
              | map(select((.severity // "" | ascii_downcase)=="critical" or (.severity // "" | ascii_downcase)=="high"))
              | if length==0 then
                  empty
                else
                  .[]
                  | "| \(.severity) | \((.package // .package_name // "unknown")) | \(.cve // "N/A") | \((.description // "" | gsub("\n"; " "))) | \((.fixVersion // .fixed_version // "N/A")) |"
                end
            ' "$SCAN_JSON" || true

            # If table had no rows, decide whether it was a real â€œ0 vulnsâ€ vs â€œskippedâ€
            if [ "$(jq -r '(.vulnerabilities // []) | map(select((.severity // "" | ascii_downcase)=="critical" or (.severity // "" | ascii_downcase)=="high")) | length' "$SCAN_JSON" 2>/dev/null)" = "0" ]; then
              if jq -e 'has("_note")' "$SCAN_JSON" >/dev/null 2>&1; then
                echo "| â€” | â€” | â€” | Scan skipped (no auth). | â€” |"
              else
                echo "| â€” | â€” | â€” | No High/Critical vulnerabilities found. | â€” |"
              fi
            fi
            echo
            echo "---"
            echo "_Generated automatically by Docker Scout GitHub Action_"
          } > docs/Docker_Scout_Report.md

      - name: Upload Markdown and JSON as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-markdown-and-json
          path: |
            docs/Docker_Scout_Report.md
            ${{ env.SCAN_JSON }}
          retention-days: 7

      # Commit report back to repo only on trusted contexts (not forked PRs)
      - name: Commit Docker Scout Report
        if: >
          ( github.event_name != 'pull_request' ) ||
          ( github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false )
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin "${BRANCH_NAME}" || true
          git add docs/Docker_Scout_Report.md
          git commit -m "Add Docker Scout Report for ${{ github.sha }}" || echo "No changes to commit"
          git push origin HEAD:"${BRANCH_NAME}"
