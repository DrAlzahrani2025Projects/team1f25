name: Docker Scout Report

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

concurrency:
  group: docker-scout-${{ github.ref }}
  cancel-in-progress: true

jobs:
  report:
    # Prevent infinite loop when the workflow pushes the Markdown file
    if: github.actor != 'github-actions[bot]' && !contains((github.event.head_commit.message || ''), 'Add Docker Scout Report')
    name: Build image, run Docker Scout CLI, and write Markdown
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write  # required to commit docs/ back to the repo on trusted events

    env:
      BRANCH_NAME: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}
      SCAN_DIR: .scan
      SCAN_JSON: .scan/report.json

    steps:
      - name: Checkout (on real branch)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH_NAME }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Choose local tag
        id: tag
        run: echo "val=local/team1f25-streamlit:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build image (local only; no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64
          load: true
          push: false
          tags: ${{ steps.tag.outputs.val }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Prepare scan dir
        run: mkdir -p "$SCAN_DIR"

      # ðŸ”¹ Run Docker Scout via the official CLI container (no GitHub Action, no Docker Hub login)
      # NOTE: If the Docker ID running in GitHub Actions is not entitled for Scout, this may return no results.
      - name: Run Docker Scout CLI (SARIF JSON)
        run: |
          set -o pipefail
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            docker/scout-cli:latest \
            cves --format sarif "${{ steps.tag.outputs.val }}" > "$SCAN_JSON" || true

      # If the CLI couldn't produce output (e.g., no entitlement), create a tiny placeholder so Markdown still renders.
      - name: Ensure placeholder report.json if missing
        run: |
          if [ ! -s "$SCAN_JSON" ]; then
            echo '{"runs":[{"tool":{"driver":{"name":"docker-scout"}},"results":[]}],"_note":"scan failed or no entitlement"}' > "$SCAN_JSON"
          fi

      - name: Debug report.json presence
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "SCAN_DIR listing:"
          ls -la "$SCAN_DIR" || true
          echo "First 200 bytes of $SCAN_JSON:"
          head -c 200 "$SCAN_JSON" || true
          echo

      - name: Generate Markdown report from SARIF
        run: |
          mkdir -p docs
          {
            echo "# Docker Scout Security Vulnerability Report"
            echo
            echo "**Date:** $(date -u)"
            echo "**Git SHA:** ${{ github.sha }}"
            echo "**Branch/Ref:** ${{ env.BRANCH_NAME }}"
            echo
            echo "## Image Scanned"
            echo "\`${{ steps.tag.outputs.val }}\`"
            echo
            echo "## Findings (from SARIF)"
            echo
            echo "| Severity | Rule ID | Location | Description |"
            echo "|-----------|---------|----------|-------------|"
            jq -r '
              (
                .runs[0].results // []
              )
              | map({
                  severity: (.level // "none"),
                  rule: (.ruleId // "N/A"),
                  location: (
                    .locations[0].physicalLocation.artifactLocation.uri // "N/A"
                  ),
                  message: (.message.text // "")
                })
              | if length == 0 then
                  empty
                else
                  .[]
                  | "| \(.severity) | \(.rule) | \(.location) | \((.message | gsub("\n"; " "))) |"
                end
            ' "$SCAN_JSON" || true

            if [ "$(jq -r '(.runs[0].results // []) | length' "$SCAN_JSON" 2>/dev/null)" = "0" ]; then
              if jq -e 'has("_note")' "$SCAN_JSON" >/dev/null 2>&1; then
                echo "| â€” | â€” | â€” | Scan failed or no entitlement. |"
              else
                echo "| â€” | â€” | â€” | No vulnerabilities found. |"
              fi
            fi
            echo
            echo "---"
            echo "_Generated automatically by Docker Scout CLI_"
          } > docs/Docker_Scout_Report.md

      - name: Upload Markdown and SARIF JSON as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-markdown-and-json
          path: |
            docs/Docker_Scout_Report.md
            ${{ env.SCAN_JSON }}
          retention-days: 7

      # Commit report back to repo only on trusted contexts (not forked PRs)
      - name: Commit Docker Scout Report
        if: >
          ( github.event_name != 'pull_request' ) ||
          ( github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false )
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin "${BRANCH_NAME}" || true
          git add docs/Docker_Scout_Report.md
          git commit -m "Add Docker Scout Report for ${{ github.sha }}" || echo "No changes to commit"
          git push origin HEAD:"${BRANCH_NAME}"
